import { getUploadRecord, type StoredUploadRecord } from '../storage/uploadRegistry.js';
import { analyzeImage, type ImageInsight } from './imageAnalyzer.js';

export type ChatAttachmentInput = {
  fileId?: string;
  fileName?: string;
  mimeType?: string;
  size?: number;
};

export type AttachmentAnalysis = ImageInsight & {
  summary: string;
};

export type AttachmentContextResult = {
  contextText: string;
  analyses: AttachmentAnalysis[];
  notes: string[];
};

const formatBytes = (value?: number | null) => {
  if (typeof value !== 'number' || !Number.isFinite(value) || value <= 0) return 'æœªçŸ¥å¤§å°';
  const units = ['B', 'KB', 'MB', 'GB', 'TB'];
  let current = value;
  let index = 0;
  while (current >= 1024 && index < units.length - 1) {
    current /= 1024;
    index += 1;
  }
  const fractionDigits = current >= 10 || index === 0 ? 0 : 1;
  return `${current.toFixed(fractionDigits)}${units[index]}`;
};

const createUnsupportedBlock = (index: number, record: StoredUploadRecord, reason: string) => {
  const name = record.originalName || record.storedName;
  return [
    `é™„ä»¶${index}ï¼?{name}`,
    `åŸºç¡€ä¿¡æ¯ï¼?{record.mimeType || 'æœªçŸ¥ç±»å‹'}ï¼Œå¤§å°?${formatBytes(record.size)}`,
    `å½“å‰æš‚ä¸æ”¯æŒè‡ªåŠ¨è§£æè¯¥ç±»å‹ï¼ˆ${reason}ï¼‰ï¼Œè¯·æ ¹æ®ç”¨æˆ·æè¿°è‡ªè¡Œå‚è€ƒã€‚`,
  ].join('\n');
};

export const buildAttachmentContext = async (
  attachments: ChatAttachmentInput[]
): Promise<AttachmentContextResult> => {
  if (!attachments.length) {
    return { contextText: '', analyses: [], notes: [] };
  }

  const seenIds = new Set<string>();
  const contextBlocks: string[] = [];
  const analyses: AttachmentAnalysis[] = [];
  const notes: string[] = [];

  let index = 0;
  for (const item of attachments) {
    if (!item || typeof item !== 'object') {
      notes.push('æ”¶åˆ°æ ¼å¼å¼‚å¸¸çš„é™„ä»¶æè¿°ï¼Œå·²å¿½ç•¥ã€?);
      continue;
    }

    const fileId = (item.fileId || '').trim();
    if (!fileId) {
      notes.push('é™„ä»¶ç¼ºå°‘ fileIdï¼Œæ— æ³•å…³è”ä¸Šä¼ è®°å½•ã€?);
      continue;
    }

    if (seenIds.has(fileId)) {
      notes.push(`é™„ä»¶ ${fileId} å·²å¤„ç†ï¼Œè·³è¿‡é‡å¤å¼•ç”¨ã€‚`);
      continue;
    }
    seenIds.add(fileId);

    const record = await getUploadRecord(fileId);
    if (!record) {
      notes.push(`æœªæ‰¾åˆ?ID ä¸?${fileId} çš„ä¸Šä¼ è®°å½•ï¼Œå¯èƒ½æ–‡ä»¶å·²è¢«æ¸…ç†ã€‚`);
      continue;
    }

    index += 1;
    if (!record.mimeType?.startsWith('image/')) {
      contextBlocks.push(createUnsupportedBlock(index, record, 'ä»…æ”¯æŒå›¾ç‰‡è¯†åˆ?));
      continue;
    }

    try {
      const insight = await analyzeImage(record);
      const baseInfoParts = [
        record.mimeType || 'æœªçŸ¥ç±»å‹',
        `å¤§å° ${formatBytes(record.size)}`,
      ];
      if (insight.width && insight.height) {
        baseInfoParts.push(`å°ºå¯¸ ${insight.width}Ã—${insight.height}`);
      }

      const lines = [
        `é™„ä»¶${index}ï¼?{record.originalName || record.storedName}`,
        `åŸºç¡€ä¿¡æ¯ï¼?{baseInfoParts.join('ï¼?)}`,
      ];

      if (insight.caption) {
        lines.push(`å›¾åƒæè¿°ï¼?{insight.caption}`);
      }
      if (insight.warnings.length) {
        lines.push(`æ³¨æ„äº‹é¡¹ï¼?{insight.warnings.join('ï¼?)}`);
      }

      contextBlocks.push(lines.join('\n'));
      analyses.push({
        ...insight,
        summary: insight.caption || lines.slice(1).join('ï¼?),
      });
    } catch (err) {
      const message = err instanceof Error ? err.message : String(err);
      notes.push(`è§£æé™„ä»¶ ${record.originalName || record.storedName} å¤±è´¥ï¼?{message}`);
      contextBlocks.push(createUnsupportedBlock(index, record, 'è§£æè¿‡ç¨‹å‘ç”Ÿå¼‚å¸¸'));
    }
  }

  return {
    contextText: contextBlocks.join('\n\n'),
    analyses,
    notes,
  };
};

